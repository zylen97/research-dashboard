name: Alternative Deploy (When SSH Fails)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'deploy-scripts/trigger-web-deploy'

jobs:
  deploy-via-web:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Check VPS Status
      run: |
        echo "ğŸ” æ£€æŸ¥VPSçŠ¶æ€..."
        echo "1. Pingæµ‹è¯•:"
        ping -c 3 45.149.156.216 || true
        
        echo "2. WebæœåŠ¡æµ‹è¯•:"
        curl -I -s http://45.149.156.216:3001 | head -5 || true
        
        echo "3. APIå¥åº·æ£€æŸ¥:"
        curl -s http://45.149.156.216:3001/api/health | jq . || true
    
    - name: Deploy via Alternative Method
      run: |
        echo "âš ï¸ SSHéƒ¨ç½²å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ..."
        
        # æ–¹æ¡ˆ1: é€šè¿‡webhookè§¦å‘ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        if [ ! -z "${{ secrets.DEPLOY_WEBHOOK_URL }}" ]; then
          echo "ğŸ”„ è§¦å‘Webhookéƒ¨ç½²..."
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"ref": "${{ github.sha }}", "branch": "main"}'
        fi
        
        # æ–¹æ¡ˆ2: æ ‡è®°éœ€è¦æ‰‹åŠ¨éƒ¨ç½²
        echo "::warning::SSHè¿æ¥å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨éƒ¨ç½²ï¼"
        echo "::warning::è¯·é€šè¿‡VPSæ§åˆ¶é¢æ¿è®¿é—®æœåŠ¡å™¨å¹¶æ‰§è¡Œï¼š"
        echo "::warning::cd /var/www/research-dashboard && ./deploy-scripts/vps-update.sh"
    
    - name: Create Issue for SSH Problem
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ SSHéƒ¨ç½²å¤±è´¥ - éœ€è¦æ‰‹åŠ¨ä»‹å…¥',
            body: `## éƒ¨ç½²å¤±è´¥è¯¦æƒ…
            
            - **æ—¶é—´**: ${new Date().toISOString()}
            - **Commit**: ${context.sha}
            - **é”™è¯¯**: SSHè¿æ¥è¢«æ‹’ç»
            
            ### è§£å†³æ­¥éª¤
            1. ç™»å½•VPSæ§åˆ¶é¢æ¿
            2. ä½¿ç”¨VNCè®¿é—®æœåŠ¡å™¨
            3. æ‰§è¡Œ: \`systemctl restart sshd\`
            4. æ‰‹åŠ¨éƒ¨ç½²: \`cd /var/www/research-dashboard && ./deploy-scripts/vps-update.sh\`
            
            ### æ£€æŸ¥é¡¹
            - [ ] SSHæœåŠ¡å·²é‡å¯
            - [ ] é˜²ç«å¢™è§„åˆ™æ­£ç¡®
            - [ ] fail2banæœªé˜»æ­¢GitHub IP
            - [ ] æ‰‹åŠ¨éƒ¨ç½²å®Œæˆ
            `,
            labels: ['bug', 'deployment', 'urgent']
          })
          console.log(`Issue created: ${issue.data.html_url}`)