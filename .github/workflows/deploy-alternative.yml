name: Alternative Deploy (When SSH Fails)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'deploy-scripts/trigger-web-deploy'

jobs:
  deploy-via-web:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Check VPS Status
      run: |
        echo "🔍 检查VPS状态..."
        echo "1. Ping测试:"
        ping -c 3 45.149.156.216 || true
        
        echo "2. Web服务测试:"
        curl -I -s http://45.149.156.216:3001 | head -5 || true
        
        echo "3. API健康检查:"
        curl -s http://45.149.156.216:3001/api/health | jq . || true
    
    - name: Deploy via Alternative Method
      run: |
        echo "⚠️ SSH部署失败，使用备用方案..."
        
        # 方案1: 通过webhook触发（如果配置了）
        if [ ! -z "${{ secrets.DEPLOY_WEBHOOK_URL }}" ]; then
          echo "🔄 触发Webhook部署..."
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"ref": "${{ github.sha }}", "branch": "main"}'
        fi
        
        # 方案2: 标记需要手动部署
        echo "::warning::SSH连接失败，需要手动部署！"
        echo "::warning::请通过VPS控制面板访问服务器并执行："
        echo "::warning::cd /var/www/research-dashboard && ./deploy-scripts/vps-update.sh"
    
    - name: Create Issue for SSH Problem
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🚨 SSH部署失败 - 需要手动介入',
            body: `## 部署失败详情
            
            - **时间**: ${new Date().toISOString()}
            - **Commit**: ${context.sha}
            - **错误**: SSH连接被拒绝
            
            ### 解决步骤
            1. 登录VPS控制面板
            2. 使用VNC访问服务器
            3. 执行: \`systemctl restart sshd\`
            4. 手动部署: \`cd /var/www/research-dashboard && ./deploy-scripts/vps-update.sh\`
            
            ### 检查项
            - [ ] SSH服务已重启
            - [ ] 防火墙规则正确
            - [ ] fail2ban未阻止GitHub IP
            - [ ] 手动部署完成
            `,
            labels: ['bug', 'deployment', 'urgent']
          })
          console.log(`Issue created: ${issue.data.html_url}`)