name: Emergency Database Fix

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/emergency-fix.yml'

jobs:
  fix-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: Execute emergency fix on VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš¨ å¼€å§‹ç´§æ€¥æ•°æ®åº“ä¿®å¤..."
          
          cd /var/www/research-dashboard/backend
          
          # å¤‡ä»½å½“å‰æ•°æ®åº“
          cp data/research_dashboard_prod.db data/research_dashboard_prod.db.emergency.$(date +%Y%m%d_%H%M%S)
          
          # æ£€æŸ¥å½“å‰è¿ç§»çŠ¶æ€
          echo "å½“å‰è¿ç§»è®°å½•ï¼š"
          sqlite3 data/research_dashboard_prod.db "SELECT * FROM migration_history ORDER BY executed_at DESC LIMIT 5;" || echo "æ— è¿ç§»è®°å½•"
          
          # æ£€æŸ¥è¡¨ç»“æ„
          echo ""
          echo "æ£€æŸ¥research_projectsè¡¨ç»“æ„ï¼š"
          sqlite3 data/research_dashboard_prod.db "PRAGMA table_info(research_projects);" | grep -E "(user_id|is_todo|todo_marked_at)" || echo "ç¼ºå°‘å…³é”®å­—æ®µ"
          
          echo ""
          echo "æ£€æŸ¥collaboratorsè¡¨ç»“æ„ï¼š"
          sqlite3 data/research_dashboard_prod.db "PRAGMA table_info(collaborators);" | grep -E "(class_info|is_senior)" || echo "ç¼ºå°‘å…³é”®å­—æ®µ"
          
          # æ‰§è¡Œv1.7è¿ç§»
          echo ""
          echo "æ‰§è¡Œv1.7è¿ç§»è„šæœ¬..."
          python3 migrations/migration.py || echo "è¿ç§»æ‰§è¡Œå¤±è´¥"
          
          # éªŒè¯è¿ç§»ç»“æœ
          echo ""
          echo "éªŒè¯è¿ç§»ç»“æœ..."
          sqlite3 data/research_dashboard_prod.db "SELECT COUNT(*) as 'ç”¨æˆ·æ•°' FROM users;"
          sqlite3 data/research_dashboard_prod.db "SELECT COUNT(*) as 'é¡¹ç›®æ•°' FROM research_projects;"
          sqlite3 data/research_dashboard_prod.db "SELECT COUNT(*) as 'åˆä½œè€…æ•°' FROM collaborators;"
          
          # é‡å¯æœåŠ¡
          echo ""
          echo "é‡å¯åç«¯æœåŠ¡..."
          sudo systemctl restart research-backend
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          sleep 3
          sudo systemctl is-active research-backend && echo "âœ… æœåŠ¡é‡å¯æˆåŠŸ" || echo "âŒ æœåŠ¡é‡å¯å¤±è´¥"
          
          echo ""
          echo "ğŸ ç´§æ€¥ä¿®å¤å®Œæˆ"