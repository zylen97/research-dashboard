name: Emergency Database Fix

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/emergency-fix.yml'

jobs:
  fix-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Execute emergency fix on VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš¨ å¼€å§‹ç´§æ€¥æ•°æ®åº“ä¿®å¤..."
          
          cd /var/www/research-dashboard/backend
          
          # å¤‡ä»½å½“å‰æ•°æ®åº“
          cp data/research_dashboard_prod.db data/research_dashboard_prod.db.emergency.$(date +%Y%m%d_%H%M%S)
          
          # ä½¿ç”¨Pythonæ£€æŸ¥æ•°æ®åº“çŠ¶æ€
          echo "æ£€æŸ¥æ•°æ®åº“çŠ¶æ€..."
          python3 -c "
import sqlite3
try:
    conn = sqlite3.connect('data/research_dashboard_prod.db')
    cursor = conn.cursor()
    
    # æ£€æŸ¥è¿ç§»å†å²
    print('å½“å‰è¿ç§»è®°å½•ï¼š')
    try:
        cursor.execute('SELECT * FROM migration_history ORDER BY executed_at DESC LIMIT 5')
        for row in cursor.fetchall():
            print(f'  {row}')
    except:
        print('  æ— è¿ç§»è®°å½•è¡¨')
    
    # æ£€æŸ¥research_projectsè¡¨
    print('\næ£€æŸ¥research_projectsè¡¨ç»“æ„ï¼š')
    cursor.execute('PRAGMA table_info(research_projects)')
    columns = [col[1] for col in cursor.fetchall()]
    print(f'  å­—æ®µ: {columns}')
    print(f'  user_id: {\"user_id\" in columns}')
    print(f'  is_todo: {\"is_todo\" in columns}')
    print(f'  todo_marked_at: {\"todo_marked_at\" in columns}')
    
    # æ£€æŸ¥collaboratorsè¡¨
    print('\næ£€æŸ¥collaboratorsè¡¨ç»“æ„ï¼š')
    cursor.execute('PRAGMA table_info(collaborators)')
    columns = [col[1] for col in cursor.fetchall()]
    print(f'  å­—æ®µ: {columns}')
    print(f'  class_info: {\"class_info\" in columns}')
    print(f'  is_senior: {\"is_senior\" in columns}')
    
    conn.close()
except Exception as e:
    print(f'é”™è¯¯: {e}')
          "
          
          # æ‰§è¡Œv1.7è¿ç§»
          echo ""
          echo "æ‰§è¡Œv1.7è¿ç§»è„šæœ¬..."
          python3 migrations/migration.py || echo "è¿ç§»æ‰§è¡Œå¤±è´¥"
          
          # éªŒè¯è¿ç§»ç»“æœ
          echo ""
          echo "éªŒè¯è¿ç§»ç»“æœ..."
          python3 -c "
import sqlite3
try:
    conn = sqlite3.connect('data/research_dashboard_prod.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT COUNT(*) FROM users')
    print(f'ç”¨æˆ·æ•°: {cursor.fetchone()[0]}')
    
    cursor.execute('SELECT COUNT(*) FROM research_projects')
    print(f'é¡¹ç›®æ•°: {cursor.fetchone()[0]}')
    
    cursor.execute('SELECT COUNT(*) FROM collaborators')
    print(f'åˆä½œè€…æ•°: {cursor.fetchone()[0]}')
    
    conn.close()
except Exception as e:
    print(f'é”™è¯¯: {e}')
          "
          
          # é‡å¯æœåŠ¡
          echo ""
          echo "é‡å¯åç«¯æœåŠ¡..."
          sudo systemctl restart research-backend
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          sleep 3
          sudo systemctl is-active research-backend && echo "âœ… æœåŠ¡é‡å¯æˆåŠŸ" || echo "âŒ æœåŠ¡é‡å¯å¤±è´¥"
          
          echo ""
          echo "ğŸ ç´§æ€¥ä¿®å¤å®Œæˆ"