name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¤ å¼€å§‹éƒ¨ç½²
      run: echo "å¼€å§‹è‡ªåŠ¨éƒ¨ç½²åˆ°VPS..."
    
    - name: ğŸš€ éƒ¨ç½²åˆ°VPS
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: 45.149.156.216
        username: root
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "ğŸ”„ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
          cd /var/www/research-dashboard
          
          echo "ğŸ”§ é…ç½® Git å®‰å…¨ç›®å½•..."
          git config --global --add safe.directory /var/www/research-dashboard
          
          echo "ğŸ“¥ å¼ºåˆ¶æ›´æ–°åˆ°æœ€æ–°ä»£ç ..."
          git fetch --all
          git reset --hard origin/main
          git clean -fd
          
          echo "ğŸ” æ˜¾ç¤ºæœ€æ–°æäº¤..."
          git log --oneline -3
          
          echo "ğŸ”„ å§‹ç»ˆæ›´æ–°Nginxé…ç½®..."
          sudo cp deployment/nginx.conf /etc/nginx/sites-available/research-dashboard
          sudo nginx -t && sudo systemctl reload nginx
          
          echo "ğŸ” æ£€æŸ¥æ›´æ”¹..."
          BACKEND_CHANGED=$(git diff HEAD~1 --name-only | grep -c "backend/" || echo "0")
          FRONTEND_CHANGED=$(git diff HEAD~1 --name-only | grep -c "frontend/" || echo "0")
          
          # æ·»åŠ å¼ºåˆ¶é‡å»ºæ ‡å¿—æ£€æŸ¥
          FORCE_REBUILD=$(git diff HEAD~1 --name-only | grep -c "FORCE_REBUILD\|force-rebuild" || echo "0")
          
          if [ "$BACKEND_CHANGED" -gt 0 ]; then
            echo "ğŸ æ£€æµ‹åˆ°åç«¯æ›´æ”¹..."
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ç›¸å…³çš„æ›´æ”¹
            USER_CHANGED=$(git diff HEAD~1 --name-only | grep -c "db_init.py" || echo "0")
            
            if [ "$USER_CHANGED" -gt 0 ]; then
              echo "ğŸ—„ï¸ æ£€æµ‹åˆ°ç”¨æˆ·é…ç½®æ›´æ”¹ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯..."
              cd backend
              
              # åªæ›´æ–°ç”¨æˆ·ï¼Œä¸åˆ é™¤æ•°æ®
              python3 -c "
import sys
sys.path.append('.')
from app.models.database import SessionLocal, User, create_tables
from app.utils.auth import get_password_hash

# ç¡®ä¿è¡¨å­˜åœ¨
create_tables()

db = SessionLocal()

# æ–°ç”¨æˆ·é…ç½®
new_users = [
    {'username': 'zl', 'email': 'zl@example.com', 'display_name': 'ZL', 'password': '123'},
    {'username': 'zz', 'email': 'zz@example.com', 'display_name': 'ZZ', 'password': '123'},
    {'username': 'yq', 'email': 'yq@example.com', 'display_name': 'YQ', 'password': '123'},
    {'username': 'dz', 'email': 'dz@example.com', 'display_name': 'DZ', 'password': '123'}
]

# æ›´æ–°æˆ–åˆ›å»ºç”¨æˆ·
for user_data in new_users:
    user = db.query(User).filter(User.username == user_data['username']).first()
    if user:
        # æ›´æ–°ç°æœ‰ç”¨æˆ·å¯†ç 
        user.password_hash = get_password_hash(user_data['password'])
        print(f'Updated password for {user.username}')
    else:
        # åˆ›å»ºæ–°ç”¨æˆ·
        user = User(
            username=user_data['username'],
            email=user_data['email'],
            display_name=user_data['display_name'],
            password_hash=get_password_hash(user_data['password'])
        )
        db.add(user)
        print(f'Created new user: {user.username}')

db.commit()
db.close()
print('âœ… ç”¨æˆ·æ›´æ–°å®Œæˆ')
"
            else
              echo "ğŸ—„ï¸ å¤‡ä»½æ•°æ®åº“..."
              cd backend
              if [ -f research_dashboard.db ]; then
                cp research_dashboard.db research_dashboard.db.backup_$(date +%Y%m%d_%H%M%S)
                echo "âœ… æ•°æ®åº“å·²å¤‡ä»½"
              fi
            fi
            
            cd ..
            
            echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
            systemctl restart research-backend
            
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5
            
            echo "âœ… åç«¯æœåŠ¡å·²é‡å¯"
          fi
          
          if [ "$FRONTEND_CHANGED" -gt 0 ] || [ "$FORCE_REBUILD" -gt 0 ]; then
            echo "âš›ï¸ æ£€æµ‹åˆ°å‰ç«¯æ›´æ”¹æˆ–å¼ºåˆ¶é‡å»ºæ ‡å¿—ï¼Œé‡æ–°æ„å»º..."
            cd frontend
            echo "ğŸ§¹ æ¸…ç†ç¼“å­˜..."
            rm -rf build node_modules/.cache
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install
            echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
            npm run build
            echo "ğŸ“‹ æ¸…ç©ºå¹¶å¤åˆ¶æ–‡ä»¶åˆ°Webç›®å½•..."
            sudo rm -rf /var/www/html/*
            sudo cp -r build/* /var/www/html/
            sudo chown -R www-data:www-data /var/www/html/
            cd ..
            echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ"
          else
            echo "ğŸ“Œ å‰ç«¯æ— æ›´æ”¹ï¼Œè·³è¿‡æ„å»º"
          fi
          
          echo "ğŸ”„ æœ€ç»ˆé‡æ–°åŠ è½½Nginx..."
          sudo systemctl reload nginx
          
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          systemctl is-active --quiet research-backend && echo "âœ… åç«¯è¿è¡Œæ­£å¸¸" || echo "âŒ åç«¯å¼‚å¸¸"
          systemctl is-active --quiet nginx && echo "âœ… Nginxè¿è¡Œæ­£å¸¸" || echo "âŒ Nginxå¼‚å¸¸"
          
          echo "ğŸ‰ è‡ªåŠ¨éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://45.149.156.216"