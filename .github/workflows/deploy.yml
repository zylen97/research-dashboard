name: ðŸ”¨ æž„å»ºéªŒè¯

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 2  # èŽ·å–æœ€è¿‘2æ¬¡æäº¤ç”¨äºŽæ¯”è¾ƒ
    
    - name: ðŸ” æ£€æŸ¥æ›´æ”¹
      id: changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶æ›´æ”¹..."
        if git diff --name-only HEAD~1 HEAD | grep -q "frontend/"; then
          echo "frontend_changed=true" >> $GITHUB_OUTPUT
          echo "âœ… å‰ç«¯æœ‰æ›´æ”¹"
        else
          echo "frontend_changed=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ å‰ç«¯æ— æ›´æ”¹"
        fi
        
        if git diff --name-only HEAD~1 HEAD | grep -q "backend/"; then
          echo "backend_changed=true" >> $GITHUB_OUTPUT
          echo "âœ… åŽç«¯æœ‰æ›´æ”¹"
        else
          echo "backend_changed=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ åŽç«¯æ— æ›´æ”¹"
        fi
    
    - name: ðŸ“¦ è®¾ç½®Node.js
      if: steps.changes.outputs.frontend_changed == 'true'
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: ðŸ”¨ æž„å»ºå‰ç«¯ï¼ˆéªŒè¯ï¼‰
      if: steps.changes.outputs.frontend_changed == 'true'
      run: |
        echo "å¼€å§‹æž„å»ºå‰ç«¯..."
        cd frontend
        npm ci
        npm run build
        echo "âœ… å‰ç«¯æž„å»ºæˆåŠŸï¼"
    
    - name: ðŸ“‹ ç”Ÿæˆéƒ¨ç½²æé†’
      if: success()
      run: |
        echo "## ðŸŽ‰ æž„å»ºéªŒè¯æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ æ›´æ”¹å†…å®¹ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "- æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- åˆ†æ”¯: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ä½œè€…: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changes.outputs.frontend_changed }}" == "true" ]; then
          echo "- âœ… å‰ç«¯æœ‰æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.changes.outputs.backend_changed }}" == "true" ]; then
          echo "- âœ… åŽç«¯æœ‰æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ éƒ¨ç½²æ­¥éª¤ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "è¯·åœ¨VPSä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½²æœ€æ–°ç‰ˆæœ¬ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "cd /var/www/research-dashboard" >> $GITHUB_STEP_SUMMARY
        echo "./vps-update.sh" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY