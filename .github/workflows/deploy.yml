name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¤ å¼€å§‹éƒ¨ç½²
      run: echo "å¼€å§‹è‡ªåŠ¨éƒ¨ç½²åˆ°VPS..."
    
    - name: ğŸš€ éƒ¨ç½²åˆ°VPS
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: 45.149.156.216
        username: root
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "ğŸ”„ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
          cd /var/www/research-dashboard
          
          echo "ğŸ”§ é…ç½® Git å®‰å…¨ç›®å½•..."
          git config --global --add safe.directory /var/www/research-dashboard
          
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main
          
          echo "ğŸ” æ£€æŸ¥æ›´æ”¹..."
          BACKEND_CHANGED=$(git diff HEAD~1 --name-only | grep -c "backend/" || echo "0")
          FRONTEND_CHANGED=$(git diff HEAD~1 --name-only | grep -c "frontend/" || echo "0")
          
          if [ "$BACKEND_CHANGED" -gt 0 ]; then
            echo "ğŸ æ£€æµ‹åˆ°åç«¯æ›´æ”¹..."
            
            echo "ğŸ—„ï¸ å¤‡ä»½å¹¶é‡å»ºæ•°æ®åº“..."
            cd backend
            if [ -f research_dashboard.db ]; then
              cp research_dashboard.db research_dashboard.db.backup_$(date +%Y%m%d_%H%M%S)
              rm -f research_dashboard.db
              echo "âœ… æ—§æ•°æ®åº“å·²å¤‡ä»½å¹¶åˆ é™¤"
            fi
            
            echo "ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“å’Œç”¨æˆ·..."
            python3 init_db.py
            
            cd ..
            
            echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
            systemctl restart research-backend
            
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5
            
            echo "âœ… åç«¯æœåŠ¡å·²é‡å¯"
          fi
          
          if [ "$FRONTEND_CHANGED" -gt 0 ]; then
            echo "âš›ï¸ æ£€æµ‹åˆ°å‰ç«¯æ›´æ”¹ï¼Œé‡æ–°æ„å»º..."
            cd frontend
            echo "ğŸ§¹ æ¸…ç†ç¼“å­˜..."
            rm -rf build node_modules/.cache
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install
            echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
            npm run build
            echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶åˆ°Webç›®å½•..."
            rm -rf /var/www/html/*
            cp -r build/* /var/www/html/
            cd ..
          fi
          
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          systemctl is-active --quiet research-backend && echo "âœ… åç«¯è¿è¡Œæ­£å¸¸" || echo "âŒ åç«¯å¼‚å¸¸"
          systemctl is-active --quiet nginx && echo "âœ… Nginxè¿è¡Œæ­£å¸¸" || echo "âŒ Nginxå¼‚å¸¸"
          
          echo "ğŸ‰ è‡ªåŠ¨éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://45.149.156.216"