name: Debug 500 Error - Simple Database Test

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'backend/test_simple_api.py'
      - '.github/workflows/debug-500.yml'

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Debug database on VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ” å¼€å§‹500é”™è¯¯æ·±åº¦è°ƒè¯•..."
          
          cd /var/www/research-dashboard/backend
          
          # ä¸‹è½½æµ‹è¯•è„šæœ¬
          curl -s https://raw.githubusercontent.com/zylen97/research-dashboard/main/backend/test_simple_api.py > test_simple_api.py
          
          # æ‰§è¡Œæ•°æ®åº“æµ‹è¯•
          echo ""
          echo "1. æ•°æ®åº“åŸºç¡€æµ‹è¯•ï¼š"
          python3 test_simple_api.py
          
          # æ£€æŸ¥åç«¯æœåŠ¡æ—¥å¿—
          echo ""
          echo "2. æ£€æŸ¥åç«¯æœåŠ¡æ—¥å¿—ï¼ˆæœ€è¿‘10è¡Œï¼‰ï¼š"
          sudo journalctl -u research-backend --no-pager -n 10
          
          # æµ‹è¯•Pythonç¯å¢ƒ
          echo ""
          echo "3. æµ‹è¯•Pythonç¯å¢ƒï¼š"
          python3 -c "
import sys
print(f'Pythonç‰ˆæœ¬: {sys.version}')

try:
    from app.models import ResearchProject, Literature, Idea, Collaborator
    print('âœ… æ‰€æœ‰æ¨¡å‹å¯¼å…¥æˆåŠŸ')
except ImportError as e:
    print(f'âŒ æ¨¡å‹å¯¼å…¥å¤±è´¥: {e}')

try:
    from sqlalchemy.orm import Session
    print('âœ… SQLAlchemyå¯¼å…¥æˆåŠŸ')
except ImportError as e:
    print(f'âŒ SQLAlchemyå¯¼å…¥å¤±è´¥: {e}')
          "
          
          # å°è¯•ç®€å•çš„ORMæŸ¥è¯¢
          echo ""
          echo "4. æµ‹è¯•ORMæŸ¥è¯¢ï¼š"
          python3 -c "
import sys
sys.path.insert(0, '.')
try:
    from app.models import get_db, ResearchProject
    from sqlalchemy.orm import sessionmaker
    from app.models.database import engine
    
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    db = SessionLocal()
    
    count = db.query(ResearchProject).count()
    print(f'âœ… ORMæŸ¥è¯¢æˆåŠŸ: {count} ä¸ªç ”ç©¶é¡¹ç›®')
    
    db.close()
except Exception as e:
    print(f'âŒ ORMæŸ¥è¯¢å¤±è´¥: {e}')
    import traceback
    traceback.print_exc()
          "
          
          echo ""
          echo "ğŸ è°ƒè¯•å®Œæˆ"