name: ğŸ” æµ‹è¯•SSHè¿æ¥

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/test-ssh.yml'

jobs:
  test-ssh-connection:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: ğŸ” æµ‹è¯•1 - æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
      run: |
        echo "=== æµ‹è¯•ç½‘ç»œè¿é€šæ€§ ==="
        ping -c 3 45.149.156.216 || true
        echo ""
        echo "=== æµ‹è¯•ç«¯å£è¿é€šæ€§ ==="
        nc -zv -w5 45.149.156.216 22 || true
        echo ""
        echo "=== æµ‹è¯•WebæœåŠ¡ ==="
        curl -I http://45.149.156.216:3001 || true

    - name: ğŸ” æµ‹è¯•2 - éªŒè¯SSHå¯†é’¥æ ¼å¼
      env:
        SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      run: |
        echo "=== æ£€æŸ¥SSHå¯†é’¥æ ¼å¼ ==="
        echo "$SSH_KEY" | head -1
        echo "..."
        echo "$SSH_KEY" | tail -1
        echo ""
        echo "=== å¯†é’¥è¡Œæ•° ==="
        echo "$SSH_KEY" | wc -l
        echo ""
        echo "=== éªŒè¯å¯†é’¥æ ¼å¼ ==="
        echo "$SSH_KEY" > temp_key
        chmod 600 temp_key
        ssh-keygen -l -f temp_key || echo "å¯†é’¥æ ¼å¼å¯èƒ½æœ‰é—®é¢˜"
        rm temp_key

    - name: ğŸ” æµ‹è¯•3 - ä½¿ç”¨åŸå§‹SSHå‘½ä»¤
      env:
        SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      run: |
        echo "=== è®¾ç½®SSHå¯†é’¥ ==="
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        echo "=== æµ‹è¯•SSHè¿æ¥ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰==="
        ssh -vvv -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 -i ~/.ssh/id_rsa \
            root@45.149.156.216 "echo 'SSHè¿æ¥æˆåŠŸ'" 2>&1 | grep -E "(debug1:|error:|Warning:|Permission denied|Connection)" | tail -30

    - name: ğŸ” æµ‹è¯•4 - ä½¿ç”¨ä¸åŒçš„SSH Actionç‰ˆæœ¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 45.149.156.216
        username: root
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script_stop: true
        script: |
          echo "æµ‹è¯•SSH Action v1.0.0"
          whoami
          pwd

    - name: ğŸ” æµ‹è¯•5 - æ·»åŠ è°ƒè¯•ä¿¡æ¯
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: 45.149.156.216
        username: root
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        debug: true
        script: |
          echo "è°ƒè¯•æ¨¡å¼æµ‹è¯•"

    - name: ğŸ“Š è¯Šæ–­æ€»ç»“
      if: always()
      run: |
        echo "=== GitHub Actions ç¯å¢ƒä¿¡æ¯ ==="
        echo "Runner OS: ${{ runner.os }}"
        echo "Runner IP: $(curl -s https://api.ipify.org)"
        echo ""
        echo "=== å¯èƒ½çš„é—®é¢˜ ==="
        echo "1. SSHå¯†é’¥æ ¼å¼é”™è¯¯ï¼ˆéœ€è¦æ£€æŸ¥secrets.VPS_SSH_KEYï¼‰"
        echo "2. æœåŠ¡å™¨é˜²ç«å¢™é˜»æ­¢äº†GitHub Actionsçš„IP"
        echo "3. SSHæœåŠ¡é…ç½®é—®é¢˜"
        echo "4. fail2banå°ç¦äº†GitHubçš„IPæ®µ"
        echo ""
        echo "=== å»ºè®® ==="
        echo "1. æ£€æŸ¥GitHub Secretsä¸­çš„VPS_SSH_KEYæ ¼å¼æ˜¯å¦æ­£ç¡®"
        echo "2. åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ: fail2ban-client status sshd"
        echo "3. æ£€æŸ¥/var/log/auth.logæŸ¥çœ‹SSHæ‹’ç»åŸå› "