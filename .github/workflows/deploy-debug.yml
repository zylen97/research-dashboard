name: ğŸ› éƒ¨ç½²è°ƒè¯•ç‰ˆæœ¬

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-debug.yml'

jobs:
  deploy-with-debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: ğŸ” æ–¹æ¡ˆ1 - ä½¿ç”¨ä¸åŒç«¯å£
      continue-on-error: true
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: 45.149.156.216
        username: root
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 10m
        script_stop: false
        script: |
          echo "å°è¯•æ ‡å‡†SSHè¿æ¥"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "å½“å‰ç›®å½•: $(pwd)"

    - name: ğŸ” æ–¹æ¡ˆ2 - ä½¿ç”¨å¯†ç è®¤è¯ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
      if: ${{ secrets.VPS_PASSWORD }}
      continue-on-error: true
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: 45.149.156.216
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          echo "ä½¿ç”¨å¯†ç è®¤è¯"
          cd /var/www/research-dashboard
          git pull
          systemctl restart research-backend

    - name: ğŸ” æ–¹æ¡ˆ3 - é€šè¿‡è·³æ¿æœºï¼ˆå¦‚æœæœ‰ï¼‰
      if: ${{ secrets.JUMP_HOST }}
      continue-on-error: true
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: 45.149.156.216
        username: root
        key: ${{ secrets.VPS_SSH_KEY }}
        proxy_host: ${{ secrets.JUMP_HOST }}
        proxy_username: ${{ secrets.JUMP_USER }}
        proxy_key: ${{ secrets.JUMP_KEY }}
        script: |
          echo "é€šè¿‡è·³æ¿æœºè¿æ¥"
          cd /var/www/research-dashboard
          ./deploy-scripts/vps-update.sh

    - name: ğŸ” æ–¹æ¡ˆ4 - åˆ›å»ºæ–°çš„éƒ¨ç½²å¯†é’¥
      run: |
        echo "=== ç”Ÿæˆæ–°çš„éƒ¨ç½²å¯†é’¥å¯¹ ==="
        ssh-keygen -t rsa -b 4096 -f deploy_key -N "" -C "github-actions@research-dashboard"
        echo ""
        echo "=== æ–°çš„å…¬é’¥ï¼ˆéœ€è¦æ·»åŠ åˆ°æœåŠ¡å™¨ï¼‰==="
        echo "è¯·å°†ä»¥ä¸‹å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨çš„ /root/.ssh/authorized_keysï¼š"
        echo "----------------------------------------"
        cat deploy_key.pub
        echo "----------------------------------------"
        echo ""
        echo "=== æ–°çš„ç§é’¥ï¼ˆéœ€è¦æ›´æ–°GitHub Secretsï¼‰==="
        echo "è¯·å°†ä»¥ä¸‹ç§é’¥æ›´æ–°åˆ° GitHub Secrets çš„ VPS_SSH_KEYï¼š"
        echo "----------------------------------------"
        cat deploy_key | head -5
        echo "... (å†…å®¹å·²æˆªæ–­) ..."
        cat deploy_key | tail -5
        echo "----------------------------------------"

    - name: ğŸ“Š å¤±è´¥åˆ†ææŠ¥å‘Š
      if: failure()
      run: |
        echo "::error::SSHéƒ¨ç½²å¤±è´¥åˆ†æ"
        echo ""
        echo "## ğŸ” è¯Šæ–­ç»“æœ"
        echo ""
        echo "### 1. æ£€æŸ¥GitHub Secrets"
        echo "- [ ] VPS_SSH_KEY æ˜¯å¦æ­£ç¡®è®¾ç½®"
        echo "- [ ] å¯†é’¥æ ¼å¼æ˜¯å¦åŒ…å« -----BEGIN RSA PRIVATE KEY-----"
        echo "- [ ] å¯†é’¥æ ¼å¼æ˜¯å¦åŒ…å« -----END RSA PRIVATE KEY-----"
        echo "- [ ] å¯†é’¥ä¸­æ˜¯å¦æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œ"
        echo ""
        echo "### 2. æœåŠ¡å™¨ç«¯æ£€æŸ¥"
        echo "éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š"
        echo "\`\`\`bash"
        echo "# æ£€æŸ¥SSHæ—¥å¿—"
        echo "tail -50 /var/log/auth.log | grep -E '(sshd|Failed|Accepted|Connection closed)'"
        echo ""
        echo "# æ£€æŸ¥fail2ban"
        echo "fail2ban-client status sshd"
        echo ""
        echo "# æ£€æŸ¥SSHé…ç½®"
        echo "grep -E '(PermitRootLogin|PubkeyAuthentication|PasswordAuthentication)' /etc/ssh/sshd_config"
        echo "\`\`\`"
        echo ""
        echo "### 3. ä¸´æ—¶è§£å†³æ–¹æ¡ˆ"
        echo "1. æ‰‹åŠ¨é€šè¿‡VNCéƒ¨ç½²"
        echo "2. ä¸´æ—¶å¼€å¯å¯†ç è®¤è¯"
        echo "3. ä½¿ç”¨webhookè§¦å‘éƒ¨ç½²"