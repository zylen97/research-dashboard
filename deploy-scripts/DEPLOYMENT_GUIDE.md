# 🚀 部署脚本使用指南

这个目录包含了前端交互的重要部署脚本，现已升级为智能部署系统。

## 📂 脚本说明

### deploy.sh - 智能部署脚本
- **核心功能**：自动检测文件修改类型，智能决定部署策略
- **智能特性**：
  - 🔍 自动检测前端/后端/文档修改
  - 🎯 根据修改内容决定是否构建前端
  - 📝 生成符合规范的提交信息
  - ⚡ 节省不必要的构建时间
  
#### 使用方法
```bash
# 智能模式（推荐）- 自动检测并执行
./deploy-scripts/deploy.sh

# 强制模式 - 手动指定
./deploy-scripts/deploy.sh --frontend   # 强制构建前端
./deploy-scripts/deploy.sh --backend    # 仅推送，不构建
./deploy-scripts/deploy.sh --all        # 构建并推送所有

# 其他选项
./deploy-scripts/deploy.sh --dry-run    # 预览模式，查看将执行的操作
./deploy-scripts/deploy.sh build        # 仅构建（兼容旧版）
```

### vps-update.sh - VPS更新脚本
- **用途**：VPS 上的部署执行脚本
- **功能**：
  - 拉取最新代码
  - 解压并部署前端文件（如果有 build.tar.gz）
  - 智能检测后端修改并重启服务
  - 应用生产环境配置
- **智能特性**：
  - 自动检测是否有前端构建包
  - 仅在后端有修改时重启服务
- **使用方法**：
  - 通常由 GitHub Actions 自动调用
  - 也可以在 VPS 上手动运行：
    ```bash
    ./deploy-scripts/vps-update.sh
    ```

## 🤖 智能检测功能

### 检测原理
脚本通过 `git status` 分析修改的文件：
- `frontend/*` → 前端文件（需要构建）
- `backend/*` → 后端文件（需要重启服务）
- 其他文件 → 文档/配置（直接推送）

### 决策流程
```
┌─────────────────┐
│  检测文件修改    │
└────────┬────────┘
         │
    ┌────┴────┐
    │前端修改?│
    └────┬────┘
         │
    ┌────┴────┐
    │   是    │──→ 构建前端 → 打包 → 提交推送
    └─────────┘
         │
    ┌────┴────┐
    │   否    │──→ 直接提交推送
    └─────────┘
```

### 提交信息规范
根据修改内容自动生成规范的提交信息：
- `feat(frontend):` - 前端功能更新
- `feat(backend):` - 后端功能更新
- `feat:` - 前后端都有更新
- `docs:` - 文档更新
- `chore:` - 配置或其他更新

## 📖 使用场景

### 场景1：前端开发工作流
```bash
# 修改了前端代码
vim frontend/src/App.tsx

# 运行智能部署
./deploy-scripts/deploy.sh
# 输出：检测到前端修改，自动构建并部署
```

### 场景2：后端开发工作流
```bash
# 修改了后端代码
vim backend/main.py

# 运行智能部署
./deploy-scripts/deploy.sh
# 输出：检测到后端修改，跳过构建，直接推送
```

### 场景3：混合开发工作流
```bash
# 同时修改了前后端
vim frontend/src/api.ts
vim backend/app/routes/auth.py

# 运行智能部署
./deploy-scripts/deploy.sh
# 输出：检测到前后端修改，构建前端并推送所有
```

### 场景4：文档更新工作流
```bash
# 只修改了文档
vim README.md

# 运行智能部署
./deploy-scripts/deploy.sh
# 输出：检测到文档修改，直接推送
```

## 🔧 高级选项

### 预览模式
查看将要执行的操作，不实际执行：
```bash
./deploy-scripts/deploy.sh --dry-run
```

### 强制构建
即使没有前端修改也要构建：
```bash
./deploy-scripts/deploy.sh --frontend
```

### 跳过构建
即使有前端修改也不构建：
```bash
./deploy-scripts/deploy.sh --backend
```

## 📊 性能对比

| 场景 | 传统方式 | 智能方式 | 节省时间 |
|------|---------|---------|----------|
| 仅改后端 | ~3分钟 | ~30秒 | 2.5分钟 |
| 仅改文档 | ~3分钟 | ~10秒 | 2.8分钟 |
| 改前端 | ~3分钟 | ~3分钟 | 无差别 |

## ⚠️ 重要提醒

1. **这两个脚本是部署系统的核心文件，请勿删除！**
2. **智能检测基于 Git 状态，确保文件已保存**
3. **首次使用建议用 --dry-run 预览**

## 🔄 完整部署流程

```
本地修改
    ↓
deploy.sh（智能检测）
    ↓
构建？（根据检测结果）
    ↓
Git 提交推送
    ↓
GitHub Actions
    ↓
VPS 拉取代码
    ↓
vps-update.sh（智能更新）
    ↓
部署完成
```

## ❓ 常见问题

### Q: 为什么检测不到我的修改？
A: 确保文件已保存，可以运行 `git status` 查看文件状态。

### Q: 如何强制重新构建前端？
A: 使用 `./deploy.sh --frontend` 或 `./deploy.sh --all`。

### Q: 提交信息可以自定义吗？
A: 目前自动生成，如需自定义建议手动 git 操作。

### Q: 预览模式显示的操作准确吗？
A: 是的，预览模式显示的就是实际将要执行的操作。

## 📝 维护说明

1. 修改脚本前请确保理解其功能
2. 测试任何改动前先备份原文件
3. 保持脚本的可执行权限（chmod +x）
4. 遵循现有的代码风格和命名规范