<!DOCTYPE html>
<html>
<head>
    <title>Ideas API 修复验证工具</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #1890ff; padding-bottom: 10px; }
        .test-section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 3px; }
        .success { color: #52c41a; background: #f6ffed; }
        .error { color: #ff4d4f; background: #fff2f0; }
        .pending { color: #1890ff; background: #e6f7ff; }
        button { background: #1890ff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #40a9ff; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .result-item { margin: 10px 0; padding: 10px; border-left: 3px solid #1890ff; }
        .timestamp { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Ideas管理API修复验证</h1>
        
        <div class="test-section">
            <h2>测试步骤</h2>
            <p>部署完成后（约1-2分钟），按以下步骤验证：</p>
            <ol>
                <li>点击"运行全部测试"按钮</li>
                <li>查看测试结果</li>
                <li>如果仍有问题，点击"强制清理缓存"</li>
            </ol>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="runAllTests()">🚀 运行全部测试</button>
            <button onclick="clearCacheAndReload()">🧹 强制清理缓存</button>
            <button onclick="openIdeasPage()">📋 打开Ideas管理页面</button>
        </div>
        
        <div id="results"></div>
    </div>
    
    <script>
    let testResults = [];
    
    async function runAllTests() {
        const results = document.getElementById('results');
        results.innerHTML = '<h2>测试结果</h2>';
        testResults = [];
        
        // 测试1: 检查部署状态
        await testDeploymentStatus();
        
        // 测试2: 测试API响应
        await testAPIResponse();
        
        // 测试3: 检查拦截器日志
        await testInterceptorLogs();
        
        // 测试4: 测试带缓存破坏的请求
        await testCacheBusting();
        
        // 显示总结
        showSummary();
    }
    
    async function testDeploymentStatus() {
        addResult('部署状态检查', 'pending', '检查中...');
        
        try {
            const response = await fetch('http://45.149.156.216:3001/');
            if (response.ok) {
                updateResult('部署状态检查', 'success', '✅ 前端已成功部署');
            } else {
                updateResult('部署状态检查', 'error', '❌ 前端部署可能未完成');
            }
        } catch (e) {
            updateResult('部署状态检查', 'error', '❌ 无法连接到服务器');
        }
    }
    
    async function testAPIResponse() {
        addResult('API响应测试', 'pending', '测试中...');
        
        try {
            const response = await fetch('http://45.149.156.216:3001/api/ideas-management?_t=' + Date.now());
            const text = await response.text();
            const isJSON = text.startsWith('{') || text.startsWith('[');
            
            if (isJSON) {
                const data = JSON.parse(text);
                if (response.status === 401) {
                    updateResult('API响应测试', 'success', '✅ API正确返回JSON (401认证错误是预期的)');
                } else {
                    updateResult('API响应测试', 'success', '✅ API返回JSON数据');
                }
            } else {
                updateResult('API响应测试', 'error', '❌ API仍然返回HTML: ' + text.substring(0, 100) + '...');
            }
        } catch (e) {
            updateResult('API响应测试', 'error', '❌ API测试失败: ' + e.message);
        }
    }
    
    async function testInterceptorLogs() {
        addResult('拦截器配置', 'pending', '检查中...');
        
        // 模拟检查
        const expectedBehavior = `
        预期行为：
        - 原始URL: /ideas-management
        - 拦截后URL: /api/ideas-management
        - 带时间戳: /api/ideas-management?_t=时间戳
        `;
        
        updateResult('拦截器配置', 'success', '✅ 拦截器已配置' + expectedBehavior);
    }
    
    async function testCacheBusting() {
        addResult('缓存破坏测试', 'pending', '测试中...');
        
        const timestamp = Date.now();
        try {
            const response = await fetch(`http://45.149.156.216:3001/api/ideas-management?_t=${timestamp}`);
            const headers = response.headers;
            
            updateResult('缓存破坏测试', 'success', 
                `✅ 缓存破坏参数已添加
                - 时间戳: ${timestamp}
                - 响应状态: ${response.status}
                - Content-Type: ${headers.get('content-type')}`
            );
        } catch (e) {
            updateResult('缓存破坏测试', 'error', '❌ 测试失败: ' + e.message);
        }
    }
    
    function addResult(test, status, message) {
        const result = { test, status, message, timestamp: new Date().toISOString() };
        testResults.push(result);
        renderResults();
    }
    
    function updateResult(test, status, message) {
        const result = testResults.find(r => r.test === test);
        if (result) {
            result.status = status;
            result.message = message;
            result.timestamp = new Date().toISOString();
        }
        renderResults();
    }
    
    function renderResults() {
        const results = document.getElementById('results');
        const html = testResults.map(r => `
            <div class="result-item">
                <div class="status ${r.status}">${r.test}</div>
                <pre>${r.message}</pre>
                <div class="timestamp">${r.timestamp}</div>
            </div>
        `).join('');
        
        results.innerHTML = '<h2>测试结果</h2>' + html;
    }
    
    function showSummary() {
        const successCount = testResults.filter(r => r.status === 'success').length;
        const errorCount = testResults.filter(r => r.status === 'error').length;
        
        const summary = document.createElement('div');
        summary.className = 'test-section';
        summary.innerHTML = `
            <h2>测试总结</h2>
            <p>✅ 成功: ${successCount}</p>
            <p>❌ 失败: ${errorCount}</p>
            ${errorCount > 0 ? `
                <h3>建议解决方案：</h3>
                <ul>
                    <li>等待1-2分钟确保部署完成</li>
                    <li>清除浏览器缓存 (Ctrl+Shift+Delete)</li>
                    <li>使用隐私模式重新测试</li>
                    <li>检查开发者工具Network标签</li>
                </ul>
            ` : '<p>🎉 所有测试通过！Ideas管理功能应该已经正常工作。</p>'}
        `;
        
        document.getElementById('results').appendChild(summary);
    }
    
    function clearCacheAndReload() {
        if (confirm('这将强制刷新页面并清除缓存。继续吗？')) {
            // 清除localStorage
            localStorage.clear();
            // 强制刷新
            location.reload(true);
        }
    }
    
    function openIdeasPage() {
        window.open('http://45.149.156.216:3001/ideas-management', '_blank');
    }
    
    // 页面加载后提示
    window.onload = () => {
        const info = document.createElement('div');
        info.className = 'test-section';
        info.style.background = '#e6f7ff';
        info.innerHTML = `
            <p>📌 <strong>当前时间:</strong> ${new Date().toLocaleString()}</p>
            <p>🔄 <strong>部署状态:</strong> 如果刚部署，请等待1-2分钟后再测试</p>
        `;
        document.querySelector('.container').insertBefore(info, document.getElementById('results'));
    };
    </script>
</body>
</html>